<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Chat{% endblock %}</title>

    <!-- Link to the style.css file -->
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">

</head>
<body>

    {% block header %}
    <header>
        <h1>Bradley Bot</h1>
    </header>
    {% endblock %}

    {% block content %}
    <!-- Chatbox Styled to Look Like a Mobile Chat -->
    <div id="chat_box" class="chat-box">
        <!-- Display the previous chat history -->
        {% for msg in chat_history %}
            <div class="message {% if msg.sender == 'Me' %}user-message{% else %}bradley-message{% endif %}">
                <strong>{% if msg.sender == 'Me' %}You:{% else %}Bradley:{% endif %}</strong>
                <div class="message-content">
                    {{ msg.message }}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Typing indicator (initially hidden) -->
    <div class="typing-indicator" style="display: none;">
        <span></span><span></span><span></span>
    </div>

    <!-- Input Container - Positioned at the bottom -->
    <form method="post" onsubmit="event.preventDefault(); sendMessage();" class="input-container">
        <div>
            <input type="text" id="user_input" placeholder="Type your message..." required>
            <button type="submit">Send</button>
        </div>
    </form>

    <script>
        async function sendMessage() {
            let userInput = document.getElementById("user_input").value;
            let chatBox = document.getElementById("chat_box");
            let typingIndicator = document.querySelector(".typing-indicator");

            // Display the user's message immediately in the chat box with "You" as the name
            chatBox.innerHTML += ` 
                <div class="message user-message">
                    <strong>You:</strong>
                    <div class="message-content">${userInput}</div>
                </div>
            `;
            
            // Clear the input field
            document.getElementById("user_input").value = "";

            // Show typing indicator
            typingIndicator.style.display = "block";

            try {
                // Send the request to FastAPI server
                let response = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({
                        "user_id": "user123", 
                        "user_input": userInput,
                        "personality": "sarcastic"  // You can adjust this dynamically
                    })
                });

                // Parse the response from the server
                let data = await response.json();
                
                // Hide typing indicator once Bradley's response is ready
                typingIndicator.style.display = "none";

                // Append Bradley's response below the user's message
                chatBox.innerHTML += ` 
                    <div class="message bradley-message">
                        <strong>Bradley:</strong>
                        <div class="message-content">${data.ai_response}</div>
                    </div>
                `;

                // Scroll to the bottom of the chat box
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                // Handle any errors
                typingIndicator.style.display = "none";
                chatBox.innerHTML += `
                    <div class="message bradley-message">
                        <strong>Bradley:</strong>
                        <div class="message-content">Error: Something went wrong.</div>
                    </div>
                `;
            }
        }
    </script>

    {% endblock %}

</body>
</html>
